<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ìœ ì†Œ ë”œë ˆë§ˆ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1a2b; /* ë” ì–´ë‘ìš´ ë°°ê²½ */
            color: #e4e4e7; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        #game-container {
            width: 100%;
            max-width: 800px;
            background-color: #1c2b46; /* ì»¨í…Œì´ë„ˆ ë°°ê²½ */
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6);
        }
        #scene-image-container {
            width: 100%;
            height: 450px; /* ê³ ì • ë†’ì´ */
            background-color: #333; /* ì´ë¯¸ì§€ ë¡œë”© ì „ ë°°ê²½ìƒ‰ */
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            overflow: hidden; 
        }
        #scene-image {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            border-radius: 8px;
            display: none; 
        }
        .image-placeholder-text {
            color: #fff;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .story-text {
            white-space: pre-wrap;
            line-height: 1.7;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        .choice-button {
            transition: all 0.2s;
        }
        .choice-button:hover {
            transform: translateY(-2px);
            background-color: #dc2626; 
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.4); 
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        .stat-item {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
            font-size: 0.85rem;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f59e0b; 
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div id="game-container">
    
    <div class="mb-6 p-4 bg-gray-800 rounded-lg">
        <div id="status-user" class="text-lg font-bold text-yellow-300 mb-3">í”Œë ˆì´ì–´: ë¡œë”© ì¤‘...</div>
        
        <!-- ìŠ¤íƒ¯ í‘œì‹œ ê·¸ë¦¬ë“œ -->
        <div id="stats-grid" class="status-grid text-xs">
            <div id="health" class="stat-item bg-red-800 text-white"></div>
            <div id="reputation" class="stat-item bg-blue-700 text-white"></div>
            <div id="morality" class="stat-item bg-green-700 text-white"></div>
            <div id="danger-level" class="stat-item bg-yellow-700 text-white"></div>
            <div id="ptsd-level" class="stat-item bg-purple-700 text-white"></div>
        </div>
    </div>

    <!-- ì¥ë©´ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ -->
    <div id="scene-image-container">
        <!-- ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œ í‘œì‹œë˜ëŠ” í…ìŠ¤íŠ¸ -->
        <div id="image-placeholder" class="image-placeholder-text">ì´ë¯¸ì§€ ë¡œë”© ì¤‘ / ì—†ìŒ</div>
        <!-- ì‹¤ì œ ì´ë¯¸ì§€ê°€ ë¡œë“œë  ê³µê°„ -->
        <img id="scene-image" src="" alt="í˜„ì¬ ì¥ë©´ ì´ë¯¸ì§€">
    </div>

    <h1 id="scene-title" class="text-4xl font-bold mb-4 text-red-300">ë¡œë”© ì¤‘...</h1>
    
    <p id="scene-description" class="story-text text-gray-300"></p>

    <div id="choices-container" class="space-y-3 mt-6">
        <!-- ì„ íƒì§€ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤. -->
        <div id="loading-indicator" class="flex justify-center hidden">
            <div class="loader"></div>
        </div>
    </div>
    
    <div id="error-message" class="mt-6 p-3 bg-red-800 text-white rounded-lg font-bold hidden"></div>

</div>

<script>
    // Game state variables
    let currentState = {};
    let currentScene = {};

    // DOM element cache
    const sceneImageContainerEl = document.getElementById('scene-image-container');
    const sceneImageEl = document.getElementById('scene-image'); 
    const imagePlaceholderEl = document.getElementById('image-placeholder');
    const sceneTitleEl = document.getElementById('scene-title');
    const sceneDescriptionEl = document.getElementById('scene-description');
    const choicesContainerEl = document.getElementById('choices-container');
    const errorEl = document.getElementById('error-message');
    const statusUserEl = document.getElementById('status-user');
    const healthEl = document.getElementById('health');
    const reputationEl = document.getElementById('reputation');
    const moralityEl = document.getElementById('morality');
    const dangerLevelEl = document.getElementById('danger-level');
    const ptsdLevelEl = document.getElementById('ptsd-level');
    const loadingIndicatorEl = document.getElementById('loading-indicator');

    function setLoading(isLoading) {
        if (isLoading) {
            choicesContainerEl.innerHTML = '';
            loadingIndicatorEl.classList.remove('hidden');
        } else {
            loadingIndicatorEl.classList.add('hidden');
        }
    }

    // Function to update and display status
    function updateUI() {
        if (!currentScene.sceneId) {
            sceneTitleEl.textContent = 'ê²Œì„ ë¡œë”© ì‹¤íŒ¨';
            sceneDescriptionEl.textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
            return;
        }
        
        // 1. Update status display
        statusUserEl.textContent = `í”Œë ˆì´ì–´: ${currentState.username}`;
        healthEl.textContent = `ì²´ë ¥: ${currentState.health}%`;
        reputationEl.textContent = `í‰íŒ: ${currentState.reputation}`;
        moralityEl.textContent = `ë„ë•ì„±: ${currentState.morality}`;
        dangerLevelEl.textContent = `ìœ„í—˜: ${currentState.dangerLevel}`;
        ptsdLevelEl.textContent = `PTSD: ${currentState.PTSDLevel}`;
        
        // 2. Update scene text
        sceneTitleEl.textContent = currentScene.title;
        sceneDescriptionEl.textContent = currentScene.description;
        
        // 3. ğŸ–¼ï¸ ì´ë¯¸ì§€ ì²˜ë¦¬ ë¡œì§ (ê°€ì¥ ë‹¨ìˆœí•˜ê³  ì•ˆì •ì ì¸ ë¡œì§)
        if (currentScene.imageUrl) {
            sceneImageEl.src = ''; // ì´ì „ ì´ë¯¸ì§€ ì†ŒìŠ¤ ì´ˆê¸°í™”
            sceneImageEl.style.display = 'none'; // ì´ë¯¸ì§€ íƒœê·¸ ìˆ¨ê¸°ê¸°
            imagePlaceholderEl.textContent = 'ì´ë¯¸ì§€ ë¡œë”© ì¤‘...';
            imagePlaceholderEl.classList.remove('hidden');
            
            // ì´ë¯¸ì§€ ë¡œë”©ì„ ì‹œë„í•©ë‹ˆë‹¤.
            const newImage = new Image();
            newImage.onload = function() {
                // ì„±ê³µ ì‹œ: í”Œë ˆì´ìŠ¤í™€ë” ìˆ¨ê¸°ê³ , ì´ë¯¸ì§€ íƒœê·¸ì— ì†ŒìŠ¤ë¥¼ ì„¤ì •í•˜ì—¬ í‘œì‹œ
                sceneImageEl.src = currentScene.imageUrl;
                sceneImageEl.style.display = 'block';
                imagePlaceholderEl.classList.add('hidden');
            };
            newImage.onerror = function() {
                // ì‹¤íŒ¨ ì‹œ: í”Œë ˆì´ìŠ¤í™€ë”ì— ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                imagePlaceholderEl.textContent = 'ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (URL ì˜¤ë¥˜ í™•ì¸)';
                imagePlaceholderEl.classList.remove('hidden');
                sceneImageEl.style.display = 'none';
            };
            // ì‹¤ì œ ë¡œë”© ì‹œì‘
            newImage.src = currentScene.imageUrl; 
        } else {
            // URLì´ ì—†ëŠ” ê²½ìš°: ì´ë¯¸ì§€ ìˆ¨ê¸°ê³  í”Œë ˆì´ìŠ¤í™€ë” í‘œì‹œ
            sceneImageEl.style.display = 'none';
            imagePlaceholderEl.textContent = 'í˜„ì¬ ì¥ë©´ì— ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.';
            imagePlaceholderEl.classList.remove('hidden');
        }

        // 4. Create choice buttons
        choicesContainerEl.innerHTML = '';
        
        currentScene.choices.forEach((choice, index) => {
            const button = document.createElement('button');
            button.className = 'choice-button w-full text-left bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md border-b-4 border-red-800';
            button.textContent = `${index + 1}. ${choice.choiceText}`;
            
            // Connect click event only if nextSceneId exists.
            if (choice.nextSceneId) {
                button.onclick = () => moveScene(choice.nextSceneId); 
            }
            
            choicesContainerEl.appendChild(button);
        });
        
        setLoading(false);
    }

    // Common function to fetch game data from the server (with retry logic)
    async function fetchGameData(url, method = 'GET', body = null) {
        errorEl.classList.add('hidden');
        setLoading(true);

        const MAX_RETRIES = 3;
        for (let i = 0; i < MAX_RETRIES; i++) {
            try {
                const options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                };
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(url, options);
                
                // Handle errors if HTTP status code is 400 or higher
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP Error ${response.status}: ${errorText.substring(0, 100)}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    currentState = data.userState;
                    currentScene = data.sceneData;
                    updateUI();
                    return true;
                } else {
                    errorEl.textContent = `ê²Œì„ ì˜¤ë¥˜: ${data.message}`;
                    errorEl.classList.remove('hidden');
                    setLoading(false);
                    return false;
                }

            } catch (error) {
                if (i < MAX_RETRIES - 1) {
                    // Apply exponential backoff (1s, 2s, 4s)
                    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
                } else {
                    console.error("Fetch Error:", error);
                    errorEl.textContent = `ì„œë²„ ì—°ê²° ì‹¤íŒ¨! Express ì„œë²„(http://localhost:8080) ì‹¤í–‰ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”. (ì˜¤ë¥˜: ${error.message})`;
                    errorEl.classList.remove('hidden');
                    setLoading(false);
                    return false;
                }
            }
        }
    }


    // Game start function (initial load)
    async function loadGame() {
        sceneTitleEl.textContent = 'ì„œë²„ ì—°ê²° ì¤‘...';
        sceneDescriptionEl.textContent = 'ì²« ë²ˆì§¸ ë”œë ˆë§ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
        await fetchGameData('http://localhost:8080/api/game/start');
    }

    // Scene transition function (called on button click)
    async function moveScene(nextSceneId) {
        const success = await fetchGameData(
            'http://localhost:8080/api/game/move', 
            'POST', 
            { 
                nextSceneId: nextSceneId,
                currentSceneId: currentScene.sceneId 
            }
        );
        
        if (success) {
            console.log(`Scene move successful: ${nextSceneId}`);
        }
    }

    // Start game on page load
    window.addEventListener('load', loadGame);
</script>

</body>
</html>